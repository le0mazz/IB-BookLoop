<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IB BookLoop · MYP & DP Used Books (Pickup Only)</title>
  <meta name="description" content="Vinted-style school marketplace for IB MYP & DP textbooks. Books priced by condition. Reserve online, pick up at school. No online payments." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --red:#B30000;
      --red-strong:#8e0000;
      --bg:#ffffff;
      --muted:#f7f7f8;
      --text:#0f0f10;
      --text-2:#4b4b50;
      --border:#e6e7eb;
      --focus:#B30000;
      --card:#ffffff;
      --shadow:0 8px 20px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--red);text-decoration:none}
    a:focus,button:focus,input:focus,select:focus,textarea:focus{outline:3px solid var(--focus);outline-offset:2px}
    header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border);backdrop-filter:saturate(180%) blur(8px)}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:12px;background:var(--red);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:var(--shadow)}
    .brand h1{font-size:18px;line-height:1;margin:0}
    nav{display:flex;gap:14px;align-items:center}
    nav a{padding:8px 10px;border-radius:10px}
    nav a[aria-current="page"], nav a:hover{background:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:transform .04s ease, box-shadow .2s}
    .btn.primary{background:var(--red);border-color:var(--red);color:#fff;box-shadow:var(--shadow)}
    .btn.primary:hover{background:var(--red-strong)}
    .btn:active{transform:translateY(1px)}
    .hero{padding:28px 0}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:22px;box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px 0;font-size:24px}
    .hero p{margin:0 0 14px 0;color:var(--text-2)}
    .section{padding:28px 0}
    .layout{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.layout{grid-template-columns:300px 1fr}}
    .sidebar{position:static;height:fit-content}
    @media(min-width:980px){.sidebar{position:sticky;top:84px}}
    .filters .row{display:grid;grid-template-columns:1fr;gap:10px}
    .filters label{font-size:12px;color:var(--text-2);display:block;margin-bottom:4px}
    .input, .select{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#fff;display:flex;flex-direction:column;box-shadow:var(--shadow)}
    .imgwrap{aspect-ratio:4/3;background:#fafafa;display:flex;align-items:center;justify-content:center}
    .imgwrap img{max-width:100%;max-height:100%;object-fit:cover;width:100%;height:100%}
    .card .info{padding:12px}
    .title{font-weight:700;margin:0 0 6px 0}
    .meta{font-size:13px;color:var(--text-2);display:flex;flex-wrap:wrap;gap:8px}
    .price{margin-top:10px;font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px}
    .tag.cond{background:#fff4f4;border-color:#ffd4d4}
    .empty{border:1px dashed var(--border);border-radius:16px;padding:22px;text-align:center;color:var(--text-2)}
    footer{margin-top:32px;border-top:1px solid var(--border);padding:18px 0;color:var(--text-2)}
    dialog{border:none;border-radius:18px;padding:0;max-width:720px;width:calc(100% - 24px);}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal{padding:18px}
    .modal header{position:sticky;top:0;border-bottom:1px solid var(--border);background:#fff}
    .modal h3{margin:0}
    .modal .content{padding:14px 0}
    .admin-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.admin-grid{grid-template-columns:1.2fr .8fr}}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);text-align:left;padding:8px;font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--muted);font-size:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .quick-add{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;display:none}
    .quick-add h4{margin:0 0 8px 0}
    .quick-add form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .quick-add .full{grid-column:1/-1}
    .thumb{width:100%;height:160px;object-fit:cover;border:1px solid var(--border);border-radius:10px}
    .hint{font-size:12px;color:var(--text-2)}
  </style>
</head>
<body>
  <header aria-label="Primary">
    <div class="container topbar" role="navigation" aria-label="Main">
      <div class="brand">
        <span class="logo" aria-hidden="true">↻</span>
        <h1>IB BookLoop</h1>
      </div>
      <nav>
        <a href="#home" aria-current="page">Home</a>
        <a href="#browse">Browse</a>
        <a href="#faq">FAQ</a>
        <a href="#admin" id="adminLink" aria-label="Admin (password required)">Admin</a>
      </nav>
    </div>
  </header>

  <main id="home" class="container" tabindex="-1">
    <section class="hero" aria-label="Intro">
      <div class="panel">
        <h2>Give Books. Help Others. Support Your IB Community.</h2>
        <p>Vinted-style marketplace for <strong>IB MYP & DP</strong> textbooks. Books are priced by condition (<strong>Like new 70%</strong>, <strong>Very good 50%</strong>, <strong>Fair 30%</strong> of the new price). Reserve online, <strong>pick up at school</strong>. No online payments.</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn primary" href="#browse">Browse Books</a>
          <a class="btn" href="#faq">How it works</a>
        </div>
      </div>
    </section>

    <section class="section" aria-label="Bring books notice">
      <div class="panel">
        <h2 style="margin:0">Bring your IB books to the <strong>MYP Building</strong> – BookLoop Box (Ground Floor)</h2>
      </div>
    </section>

    <section id="browse" class="section" aria-label="Browse catalog">
      <div class="layout">
        <aside class="sidebar">
          <div class="panel filters" role="region" aria-label="Filters">
            <div class="row">
              <div>
                <label for="q">Search</label>
                <input id="q" class="input" type="search" placeholder="Title or author" />
              </div>
              <div>
                <label for="programme">Programme</label>
                <select id="programme" class="select">
                  <option value="">Any</option><option>MYP</option><option>DP</option>
                </select>
              </div>
              <div>
                <label for="subject">Subject</label>
                <select id="subject" class="select">
                  <option value="">Any</option>
                  <option>Mathematics</option><option>Sciences</option><option>Language & Literature</option><option>Language Acquisition</option><option>Individuals & Societies</option><option>Arts</option><option>PE</option>
                </select>
              </div>
              <div>
                <label for="year">Year level</label>
                <select id="year" class="select">
                  <option value="">Any</option>
                  <option>MYP1</option><option>MYP2</option><option>MYP3</option><option>MYP4</option><option>MYP5</option><option>DP1</option><option>DP2</option>
                </select>
              </div>
              <div>
                <label for="maxPrice">Max price (€)</label>
                <input id="maxPrice" class="input" type="number" inputmode="numeric" placeholder="e.g. 30" min="0" step="1" />
              </div>
              <div>
                <button class="btn" id="clearFilters" title="Clear filters" style="width:100%">Clear</button>
              </div>
            </div>
          </div>

          <!-- Quick Add (shown after admin login) -->
          <div id="quickAdd" class="quick-add panel" role="region" aria-label="Quick add book">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <h4 style="margin:0">Quick Add (Admin)</h4>
              <button id="logoutQuickBtn" class="btn" type="button">Logout Admin</button>
            </div>
            <form id="quickAddForm">
              <input id="qa_title" class="input" placeholder="Title" required />
              <input id="qa_author" class="input" placeholder="Author" />
              <select id="qa_prog" class="select" required>
                <option value="">Programme</option>
                <option>MYP</option><option>DP</option>
              </select>
              <select id="qa_subj" class="select" required>
                <option value="">Subject</option>
                <option>Mathematics</option><option>Sciences</option><option>Language & Literature</option><option>Language Acquisition</option><option>Individuals & Societies</option><option>Arts</option><option>PE</option>
              </select>
              <select id="qa_year" class="select" required>
                <option value="">Year</option>
                <option>MYP1</option><option>MYP2</option><option>MYP3</option><option>MYP4</option><option>MYP5</option><option>DP1</option><option>DP2</option>
              </select>
              <select id="qa_condition" class="select" required>
                <option value="">Condition</option>
                <option>Like new</option>
                <option>Very good</option>
                <option>Fair</option>
              </select>
              <input id="qa_new" class="input" type="number" min="0" step="1" placeholder="New price (€)" required />
              <div class="full">
                <label class="hint">Cover image (optional)</label>
                <input id="qa_img_file" class="input" type="file" accept="image/*" />
                <img id="qa_preview" class="thumb" alt="" style="display:none" />
              </div>
              <div class="full" style="display:flex;gap:8px">
                <button class="btn primary" type="submit">Add book</button>
                <span id="qa_status" class="hint"></span>
              </div>
            </form>
          </div>
        </aside>

        <div>
          <div id="catalog" class="grid" aria-live="polite"></div>
          <div id="emptyState" class="empty panel" hidden>No books found. Try adjusting filters.</div>
        </div>
      </div>
    </section>

    <section id="faq" class="section" aria-label="FAQ & Contact">
      <div class="panel">
        <h3>FAQ & Contact</h3>
        <p><strong>How it works:</strong> families leave IB books in the BookLoop Box at the <strong>MYP Building</strong>. We add them to the catalog. Price depends on condition (<em>Like new 70%, Very good 50%, Fair 30%</em> of new price). You reserve online and pick up at the school desk during available slots.</p>
        <p><strong>Pickup & payment:</strong> pickup happens at the school location shown at booking; bring the exact amount (charity pricing). No online payments.</p>
        <p><strong>GDPR:</strong> we collect only your <strong>name</strong> to manage the reservation. Data are not shared with third parties.</p>
        <p><strong>Contact:</strong> <a href="mailto:bookloop@school.local">bookloop@school.local</a></p>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>IB BookLoop — Student-led project. Pickup only. No email required for booking.</p>
    </div>
  </footer>

  <!-- Book modal -->
  <dialog id="bookModal" aria-labelledby="bookTitleLabel">
    <div class="modal">
      <header class="topbar" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <h3 id="bookTitleLabel" style="font-size:18px">Book</h3>
        <button class="btn" type="button" onclick="bookModal.close()" aria-label="Close">Close</button>
      </header>
      <div class="content">
        <div style="display:grid;grid-template-columns:1fr;gap:16px">
          <div class="imgwrap" style="background:#fff;border:1px solid var(--border);border-radius:12px">
            <img id="bookImg" alt="Book cover" />
          </div>
          <div>
            <p class="muted" id="bookMeta"></p>
            <p class="price" id="bookPrice"></p>
            <p id="bookCond" class="muted"></p>
            <button id="reserveBtn" class="btn primary" type="button">Reserve Book</button>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Reservation modal (Calendar-only) -->
  <dialog id="reserveModal" aria-labelledby="reserveTitle">
    <div class="modal">
      <header class="topbar" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <h3 id="reserveTitle" style="font-size:18px">Reserve pickup</h3>
        <button class="btn" type="button" onclick="reserveModal.close()" aria-label="Close">Close</button>
      </header>
      <div class="content">
        <div style="display:grid;grid-template-columns:1fr;gap:12px">
          <a class="btn primary" href="https://calendar.app.google/AphKbShRvHjqcTev5" target="_blank" rel="noopener">Open Google Calendar booking page</a>
          <p class="muted" style="margin:0">Appointments are scheduled on Google Calendar (limited to <strong>before 16:15</strong>).</p>
          <div style="margin-top:10px;display:flex;gap:10px">
            <button class="btn" type="button" onclick="reserveModal.close()">Close</button>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Admin modal -->
  <dialog id="adminModal" aria-labelledby="adminTitle">
    <div class="modal">
      <header class="topbar" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <h3 id="adminTitle" style="font-size:18px">Admin</h3>
        <div style="display:flex;gap:8px">
          <button id="logoutInAdmin" class="btn" type="button">Logout Admin</button>
          <button class="btn" type="button" onclick="adminModal.close()" aria-label="Close">Close</button>
        </div>
      </header>
      <div class="content">
        <div id="adminGate">
          <p class="muted">Enter admin password to manage inventory and reservations.</p>
          <form id="adminLogin" style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="adminPass" type="password" placeholder="Password" class="input" />
            <button class="btn primary" type="submit">Enter</button>
          </form>
          <p id="adminMsg" class="muted" role="alert"></p>
        </div>
        <div id="adminBody" hidden>
          <div class="admin-grid">
            <section>
              <h4>Add / Edit Book</h4>
              <form id="bookForm" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <input type="hidden" id="bookId" />
                <input id="title" class="input" placeholder="Title" required />
                <input id="author" class="input" placeholder="Author" />
                <select id="prog" class="select" required>
                  <option value="">Programme</option>
                  <option>MYP</option>
                  <option>DP</option>
                </select>
                <select id="subj" class="select" required>
                  <option value="">Subject</option>
                  <option>Mathematics</option>
                  <option>Sciences</option>
                  <option>Language & Literature</option>
                  <option>Language Acquisition</option>
                  <option>Individuals & Societies</option>
                  <option>Arts</option>
                  <option>PE</option>
                </select>
                <select id="yearLevel" class="select" required>
                  <option value="">Year</option>
                  <option>MYP1</option><option>MYP2</option><option>MYP3</option><option>MYP4</option><option>MYP5</option>
                  <option>DP1</option><option>DP2</option>
                </select>
                <select id="condition" class="select" required>
                  <option value="">Condition</option>
                  <option>Like new</option>
                  <option>Very good</option>
                  <option>Fair</option>
                </select>
                <input id="newPrice" class="input" type="number" min="0" step="1" placeholder="New price (€)" required />
                <input id="loopPrice" class="input" type="number" min="0" step="1" placeholder="BookLoop price (€)" required readonly />
                <select id="availability" class="select" required>
                  <option>Available</option>
                  <option>Reserved</option>
                  <option>Picked Up</option>
                </select>
                <div class="full">
                  <label class="hint">Cover image (optional)</label>
                  <input id="img_file" class="input" type="file" accept="image/*" />
                  <img id="img_preview" class="thumb" alt="" style="display:none" />
                </div>
                <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center">
                  <button class="btn primary" type="submit">Save</button>
                  <button class="btn" type="button" id="resetForm">Reset</button>
                  <button class="btn" type="button" id="deleteBookBtn" hidden style="border-color:#ffd4d4;background:#fff4f4;color:#8e0000">Delete book</button>
                </div>
              </form>
            </section>
            <section>
              <h4>Quick Stats</h4>
              <p><span class="chip">Total books: <span id="statBooks">0</span></span></p>
              <p><span class="chip">Available: <span id="statAvail">0</span></span></p>
              <p><span class="chip">Reserved: <span id="statRes">0</span></span></p>
              <p><span class="chip">Picked Up: <span id="statDone">0</span></span></p>
              <h4 style="margin-top:14px">Reservations</h4>
              <table class="table" aria-label="Reservations table">
                <thead><tr><th>Book</th><th>Student</th><th>Slot</th></tr></thead>
                <tbody id="resTable"></tbody>
              </table>
            </section>
          </div>
          <h4 style="margin-top:16px">Inventory</h4>
          <table class="table" aria-label="Inventory table">
            <thead>
              <tr><th>Title</th><th>Programme</th><th>Subject</th><th>Year</th><th>New</th><th>Price</th><th>Condition</th><th>Status</th><th></th></tr>
            </thead>
            <tbody id="invTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </dialog>

  <script>

    
    // ---- Shared data layer (Google Sheet via Sheet.best)
    // This replaces localStorage: everyone sees the same catalog.
    const store = {
      books: [],
      reservations: [],
      adminLoggedIn: false,
    };

    // 1) Create a Sheet.best connection and paste its URL here.
    // Example: https://api.sheetbest.com/sheets/<YOUR_API_ID>
    const API_URL = "https://api.sheetbest.com/sheets/b9b10078-eebe-4c3f-b80a-ec807092c07c";

    // Keep these as no-ops for compatibility with the rest of the file.
    const persist = () => {};
    const restore = () => { store.adminLoggedIn = false; };

    async function apiGetBooks(){
      const r = await fetch(API_URL, { method: "GET", mode: "cors" });
      if (!r.ok) throw new Error("GET books failed: " + r.status);
      const rows = await r.json();
      const list = Array.isArray(rows) ? rows : [];
      // Normalize types + defaults
      return list
        .filter(x => x && (x.title || x.Title))
        .map((x) => ({
          id: (x.id ?? x.Id ?? crypto.randomUUID()).toString(),
          title: (x.title ?? x.Title ?? "").toString(),
          author: (x.author ?? x.Author ?? "").toString(),
          programme: (x.programme ?? x.Programme ?? "").toString(),
          subject: (x.subject ?? x.Subject ?? "").toString(),
          year: (x.year ?? x.Year ?? "").toString(),
          condition: (x.condition ?? x.Condition ?? "").toString(),
          newPrice: parseInt(x.newPrice ?? x["newPrice"] ?? x["NewPrice"] ?? x["New Price"] ?? x.NewPrice ?? x["New price"] ?? x.new_price ?? x.New ?? x.new ?? 0, 10) || 0,
          loopPrice: parseInt(x.loopPrice ?? x["loopPrice"] ?? x["LoopPrice"] ?? x["Loop Price"] ?? x.LoopPrice ?? x["Loop price"] ?? x.loop_price ?? x.Loop ?? x.loop ?? 0, 10) || 0,
          availability: (x.availability ?? x.Availability ?? "Available").toString(),
          img: (x.img ?? x.Img ?? x.image ?? x.Image ?? "").toString(),
        }));
    }

    async function apiUpsertBook(book){
      // Update by id (filtered update). If it doesn't exist, insert.
      const filteredUrl = `${API_URL}/id/${encodeURIComponent(book.id)}`;
      const patchResp = await fetch(filteredUrl, {
        method: "PATCH",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(book),
      });
      // If nothing matched, Sheet.best typically returns [].
      let patched = [];
      try { patched = await patchResp.json(); } catch(e) {}
      if (Array.isArray(patched) && patched.length > 0) return patched;

      const postResp = await fetch(API_URL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(book),
      });
      if (!postResp.ok) throw new Error("POST book failed: " + postResp.status);
      return await postResp.json();
    }

    async function apiDeleteBook(id){
      const filteredUrl = `${API_URL}/id/${encodeURIComponent(id)}`;
      const r = await fetch(filteredUrl, { method: "DELETE", mode: "cors" });
      if (!r.ok) throw new Error("DELETE book failed: " + r.status);
      return await r.json().catch(() => ({}));
    }

    async function refreshBooks(){
      // Minimal "eventual consistency" for small groups:
      // read from server and re-render.
      try{
        store.books = await apiGetBooks();
      }catch(e){
        console.error(e);
        store.books = [];
        alert("Unable to load shared catalog. Check API_URL and permissions.");
      }
      renderCatalog();
      if (store.adminLoggedIn) renderAdminTables();
    }

    // Elements// Elements
    const catalogEl = document.getElementById('catalog');
    const emptyEl = document.getElementById('emptyState');
    const qEl = document.getElementById('q');
    const programmeEl = document.getElementById('programme');
    const subjectEl = document.getElementById('subject');
    const yearEl = document.getElementById('year');
    const maxPriceEl = document.getElementById('maxPrice');
    const quickAddBox = document.getElementById('quickAdd');
    const qaForm = document.getElementById('quickAddForm');
    const qaStatus = document.getElementById('qa_status');
    const qaFile = document.getElementById('qa_img_file');
    const qaPrev = document.getElementById('qa_preview');

    const bookModal = document.getElementById('bookModal');
    const reserveModal = document.getElementById('reserveModal');
    const adminModal = document.getElementById('adminModal');

    // Init
    restore();
    refreshBooks();
    syncQuickAddVisibility();

    // Filters
    [qEl, programmeEl, subjectEl, yearEl, maxPriceEl].forEach(el => el && el.addEventListener('input', renderCatalog));
    const clearBtn = document.getElementById('clearFilters');
    if (clearBtn) clearBtn.addEventListener('click', () => {
      if(qEl) qEl.value = ''; if(programmeEl) programmeEl.value=''; if(subjectEl) subjectEl.value=''; if(yearEl) yearEl.value=''; if(maxPriceEl) maxPriceEl.value=''; renderCatalog();
    });

    function renderCatalog(){
      const q = (qEl?.value || '').trim().toLowerCase();
      const prog = programmeEl?.value || '';
      const subj = subjectEl?.value || '';
      const year = yearEl?.value || '';
      const max = parseInt(maxPriceEl?.value || '0',10);
      const list = store.books.filter(b => {
        if (prog && b.programme!==prog) return false;
        if (subj && b.subject!==subj) return false;
        if (year && b.year!==year) return false;
        if (max && b.loopPrice>max) return false;
        if (!q) return true;
        const hay = (b.title+" "+(b.author||'')).toLowerCase();
        return hay.includes(q);
      });
      catalogEl.innerHTML = '';
      if (list.length===0){ emptyEl.hidden=false; return; } else emptyEl.hidden=true;
      for (const b of list){
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="imgwrap">${b.img?`<img src="${b.img}" alt="${b.title} cover"/>`:'<span class="muted" style="padding:8px">No image</span>'}</div>
          <div class="info">
            <p class="title">${b.title}</p>
            <div class="meta">
              <span class="tag">${b.programme}</span>
              <span class="tag">${b.subject}</span>
              <span class="tag">${b.year}</span>
              <span class="tag cond" title="Condition">${b.condition||'—'}</span>
            </div>
            <p class="price">€ ${b.loopPrice} <span class="muted" style="font-weight:400">(new €${b.newPrice})</span></p>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn primary" ${b.availability!=='Available'?'disabled':''} aria-disabled="${b.availability!=='Available'}">${b.availability==='Available'?'Reserve':'Not available'}</button>
              <button class="btn">Details</button>
            </div>
          </div>`;
        const [reserveBtn, detailsBtn] = card.querySelectorAll('button');
        reserveBtn.addEventListener('click', () => openReserve(b.id));
        detailsBtn.addEventListener('click', () => openBook(b.id));
        catalogEl.appendChild(card);
      }
    }

    function openBook(id){
      const b = store.books.find(x=>x.id===id); if(!b) return;
      document.getElementById('bookTitleLabel').textContent=b.title;
      document.getElementById('bookMeta').textContent=`${b.author||''} · ${b.programme} · ${b.subject} · ${b.year}`;
      document.getElementById('bookPrice').textContent=`€ ${b.loopPrice} (new €${b.newPrice})`;
      document.getElementById('bookCond').textContent=`Condition: ${b.condition||'—'}`;
      document.getElementById('bookImg').src=b.img||'';
      document.getElementById('reserveBtn').onclick=()=>openReserve(id);
      bookModal.showModal();
    }

    function openReserve(id){
      const b = store.books.find(x=>x.id===id); if(!b) return;
      document.getElementById('reserveTitle').textContent = `Reserve: ${b.title}`;
      reserveModal.showModal();
    }

    // Admin link opens login gate each time
    document.getElementById('adminLink').addEventListener('click', (e)=>{
      e.preventDefault();
      document.getElementById('adminGate').hidden=false;
      document.getElementById('adminBody').hidden=true;
      adminModal.showModal();
    });

    // Password
    const ADMIN_PASSWORD = '18!02!2OO9'; // last two are capital 'O'
    document.getElementById('adminLogin').addEventListener('submit', (e)=>{
      e.preventDefault();
      const pass = document.getElementById('adminPass').value;
      if (pass===ADMIN_PASSWORD){
        document.getElementById('adminGate').hidden=true;
        document.getElementById('adminBody').hidden=false;
        store.adminLoggedIn = true;
        persist();
        syncQuickAddVisibility();
        renderAdminTables();
        syncDeleteVisibility();
      } else {
        document.getElementById('adminMsg').textContent='Incorrect password';
      }
    });

    // Logout buttons
    document.getElementById('logoutInAdmin').addEventListener('click', logoutAdmin);
    document.getElementById('logoutQuickBtn').addEventListener('click', logoutAdmin);

    // Pricing by condition helper
    function priceFromCondition(newPrice, condition){
      const p = parseFloat(newPrice||0);
      const map = {'Like new':0.7, 'Very good':0.5, 'Fair':0.3};
      const f = map[condition] || 0.5;
      return Math.round(p*f);
    }

    // Admin form
    const bookForm = document.getElementById('bookForm');
    const np = document.getElementById('newPrice');
    const lp = document.getElementById('loopPrice');
    const condSel = document.getElementById('condition');
    const imgFile = document.getElementById('img_file');
    const imgPrev = document.getElementById('img_preview');

    function recalcPrice(){ lp.value = priceFromCondition(np.value, condSel.value); }
    np.addEventListener('input', recalcPrice);
    condSel.addEventListener('change', recalcPrice);

    imgFile.addEventListener('change', ()=>{
      const f = imgFile.files?.[0];
      if(!f){ imgPrev.style.display='none'; imgPrev.src=''; return; }
      const reader = new FileReader();
      reader.onload = e => { imgPrev.src = e.target.result; imgPrev.style.display='block'; };
      reader.readAsDataURL(f);
    });

    if (bookForm) bookForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      let dataUrl = '';
      const file = imgFile.files?.[0];
      if (file){
        dataUrl = await fileToDataURL(file);
      }
      const data = {
        id: document.getElementById('bookId').value || crypto.randomUUID(),
        title: document.getElementById('title').value.trim(),
        author: document.getElementById('author').value.trim(),
        programme: document.getElementById('prog').value,
        subject: document.getElementById('subj').value,
        year: document.getElementById('yearLevel').value,
        condition: condSel.value,
        newPrice: parseInt(np.value,10),
        loopPrice: parseInt(lp.value,10),
        availability: document.getElementById('availability').value,
        img: dataUrl || imgPrev.src || ''
      };
      if(!store.adminLoggedIn){ alert('Admin only. Open Admin and login first.'); return; }
      data.updatedAt = new Date().toISOString();
      await apiUpsertBook(data);
      await refreshBooks();
      resetBookForm();
    });

    // Admin: reset/delete helpers
    const deleteBookBtn = document.getElementById('deleteBookBtn');
    const resetBtn = document.getElementById('resetForm');

    function syncDeleteVisibility(){
      if(!deleteBookBtn) return;
      const hasId = !!document.getElementById('bookId').value;
      deleteBookBtn.hidden = !hasId;
    }

    function resetBookForm(){
      if(bookForm) bookForm.reset();
      document.getElementById('bookId').value='';
      lp.value='';
      imgPrev.src='';
      imgPrev.style.display='none';
      if (imgFile) imgFile.value='';
      syncDeleteVisibility();
    }

    if (resetBtn) resetBtn.addEventListener('click', resetBookForm);

    if (deleteBookBtn) deleteBookBtn.addEventListener('click', async ()=>{
      if(!store.adminLoggedIn){ alert('Admin not logged in'); return; }
      const id = document.getElementById('bookId').value;
      if(!id) return;
      const b = store.books.find(x=>x.id===id);
      const title = b ? b.title : 'this book';
      if(!confirm(`Delete "${title}" permanently? This cannot be undone.`)) return;

      if(!store.adminLoggedIn){ alert('Admin only.'); return; }
      await apiDeleteBook(id);
      await refreshBooks();
      resetBookForm();
    });

    // Quick Add handlers (with file upload)
    function syncQuickAddVisibility(){
      quickAddBox.style.display = store.adminLoggedIn ? 'block' : 'none';
    }
    qaFile.addEventListener('change', ()=>{
      const f = qaFile.files?.[0];
      if(!f){ qaPrev.style.display='none'; qaPrev.src=''; return; }
      const reader = new FileReader();
      reader.onload = e => { qaPrev.src = e.target.result; qaPrev.style.display='block'; };
      reader.readAsDataURL(f);
    });

    async function fileToDataURL(file){
      return await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = e => resolve(e.target.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    document.getElementById('quickAddForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!store.adminLoggedIn){ alert('Admin not logged in'); return; }
      let dataUrl='';
      const f = qaFile.files?.[0];
      if (f){ dataUrl = await fileToDataURL(f); }
      const title = document.getElementById('qa_title').value.trim();
      const prog = document.getElementById('qa_prog').value;
      const subj = document.getElementById('qa_subj').value;
      const year = document.getElementById('qa_year').value;
      const cond = document.getElementById('qa_condition').value;
      const newP = parseInt(document.getElementById('qa_new').value,10);
      if(!title || !prog || !subj || !year || !cond || !isFinite(newP)){
        qaStatus.textContent = 'Please fill all required fields.'; return;
      }
      const book = {
        id: crypto.randomUUID(),
        title,
        author: document.getElementById('qa_author').value.trim(),
        programme: prog,
        subject: subj,
        year,
        condition: cond,
        newPrice: newP,
        loopPrice: priceFromCondition(newP, cond),
        availability: 'Available',
        img: dataUrl
      };
      if(!store.adminLoggedIn){ alert('Admin only.'); return; }
      book.updatedAt = new Date().toISOString();
      await apiUpsertBook(book);
      await refreshBooks();
      e.target.reset(); qaPrev.src=''; qaPrev.style.display='none';
      qaStatus.textContent = 'Book added to the shared catalog.';
      setTimeout(()=>qaStatus.textContent='', 1500);
      window.scrollTo({top: document.getElementById('browse').offsetTop, behavior:'smooth'});
});

    function renderAdminTables(){
      const invT = document.getElementById('invTable');
      if (!invT) return;
      invT.innerHTML='';
      for (const b of store.books){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${b.title}</td><td>${b.programme}</td><td>${b.subject}</td><td>${b.year}</td><td>€${b.newPrice}</td><td>€${b.loopPrice}</td><td>${b.condition||'—'}</td><td>${b.availability}</td><td><button class="btn" data-id="${b.id}">Edit</button></td>`;
        tr.querySelector('button').addEventListener('click', ()=>{
          document.getElementById('bookId').value=b.id;
          document.getElementById('title').value=b.title;
          document.getElementById('author').value=b.author||'';
          document.getElementById('prog').value=b.programme;
          document.getElementById('subj').value=b.subject;
          document.getElementById('yearLevel').value=b.year;
          document.getElementById('condition').value=b.condition||'';
          document.getElementById('newPrice').value=b.newPrice;
          document.getElementById('loopPrice').value=b.loopPrice;
          document.getElementById('availability').value=b.availability;
          imgPrev.src=b.img||'';
          imgPrev.style.display=b.img?'block':'none';
          syncDeleteVisibility();
          adminModal.scrollTop=0;
        });
        invT.appendChild(tr);
      }
      document.getElementById('statBooks').textContent = store.books.length;
      document.getElementById('statAvail').textContent = store.books.filter(b=>b.availability==='Available').length;
      document.getElementById('statRes').textContent = store.books.filter(b=>b.availability==='Reserved').length;
      document.getElementById('statDone').textContent = store.books.filter(b=>b.availability==='Picked Up').length;

      const resT = document.getElementById('resTable');
      resT.innerHTML='';
      for (const r of store.reservations){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.bookTitle}</td><td>${r.studentName}</td><td>${r.pickupSlot}</td>`;
        resT.appendChild(tr);
      }
    }

    // Keyboard quick search
    document.addEventListener('keydown',(e)=>{
      if(e.key==='/' && document.activeElement.tagName!=='INPUT'){ e.preventDefault(); qEl.focus(); }
    });
  
</script>
</body>
</html>
