<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IB BookLoop</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --panel2:#12213a;
      --text:#eaf0ff; --muted:#a8b4d6;
      --brand:#4f7cff; --brand2:#2ed3b7;
      --danger:#ff4d4d; --ok:#2ed3b7; --warn:#ffcc66;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, #14254a 0%, var(--bg) 55%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px; background: rgba(15,26,46,.75); border:1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px);
      position: sticky; top: 10px; z-index: 10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid;place-items:center;font-weight:800;
      box-shadow: 0 8px 20px rgba(79,124,255,.25);
    }
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding:10px 12px;border-radius:999px;
      color:var(--text);
      outline:none;
    }
    .pill::placeholder{color: rgba(234,240,255,.55)}
    select.pill{cursor:pointer}
    button, .btnLink{
      border:1px solid var(--border);
      background: rgba(255,255,255,.07);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    button:hover, .btnLink:hover{background: rgba(255,255,255,.11)}
    button:active, .btnLink:active{transform: translateY(1px)}
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .primary{
      background: linear-gradient(135deg,var(--brand),#6a8bff);
      border-color: rgba(255,255,255,.15);
    }
    .danger{
      background: rgba(255,77,77,.12);
      border-color: rgba(255,77,77,.35);
    }
    .ok{
      background: rgba(46,211,183,.12);
      border-color: rgba(46,211,183,.35);
    }
    .panel{
      margin-top:16px;
      background: rgba(15,26,46,.75);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .panelHead .meta{color:var(--muted);font-size:12px}
    .panelBody{padding:16px}
    .status{font-size:13px;color:var(--muted)}
    .status b{color:var(--text)}
    .grid{
      display:grid;gap:12px;
      grid-template-columns: repeat( auto-fit, minmax(240px, 1fr) );
    }

    /* Card a 2 colonne: info (sinistra) + immagine (destra) */
    .cardRow{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:0;
      min-height: 260px;
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .infoCol{
      padding:14px;
      border-right:1px solid var(--border);
      background: rgba(18,33,58,.65);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .imgCol{
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      padding:12px;
    }
    .imgCol img{
      width:100%;
      height:100%;
      max-height: 236px;
      object-fit: contain;
      display:block;
      border-radius:12px;
      background: rgba(0,0,0,.10);
      border:1px solid var(--border);
    }

    @media (max-width: 860px){
      .cardRow{
        grid-template-columns: 1fr;
        min-height: unset;
      }
      .infoCol{
        border-right:0;
        border-bottom:1px solid var(--border);
      }
      .imgCol img{
        max-height: 240px;
      }
    }

    .badge{
      font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      align-self:flex-start;
    }
    .badge.ok{background: rgba(46,211,183,.18); border-color: rgba(46,211,183,.35)}
    .badge.warn{background: rgba(255,204,102,.18); border-color: rgba(255,204,102,.35)}
    .badge.danger{background: rgba(255,77,77,.18); border-color: rgba(255,77,77,.35)}

    .title{font-weight:800;line-height:1.2;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .kv{display:grid;grid-template-columns: 90px 1fr;gap:6px 10px;font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:700}

    .cardActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .tiny{padding:8px 10px;border-radius:10px;font-size:13px}

    .footerNote{
      margin-top:10px;color:rgba(234,240,255,.55);font-size:12px;line-height:1.35
    }
    .hr{height:1px;background:var(--border);margin:14px 0}
    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width: 860px){ .twoCol{grid-template-columns: 1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:rgba(234,240,255,.55);margin-top:6px}
    .hidden{display:none !important}

    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:13px;
      white-space:pre-line;
    }
    .toast.ok{border-color: rgba(46,211,183,.35); background: rgba(46,211,183,.10)}
    .toast.danger{border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10)}

    /* Reserve modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalCard{
      width:min(560px, 100%);
      background: rgba(15,26,46,.92);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .modalBody{ padding:14px; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">IB</div>
        <div>
          <h1>IB BookLoop</h1>
          <div class="sub">Catalogo libri condiviso (Google Sheets)</div>
        </div>
      </div>

      <div class="row">
        <input id="q" class="pill" style="min-width:260px" placeholder="Cerca titolo / autore / materia..." />
        <select id="fProgram" class="pill">
          <option value="">Tutti i programmi</option>
          <option>IBDP</option>
          <option>IGCSE</option>
          <option>MYP</option>
          <option>Altro</option>
        </select>
        <select id="fAvail" class="pill">
          <option value="">Tutte le disponibilità</option>
          <option value="Available">Available</option>
          <option value="Reserved">Reserved</option>
          <option value="Sold">Sold</option>
        </select>

        <button id="btnRefresh">Aggiorna</button>
        <button id="btnAdmin" class="primary">Admin</button>
      </div>
    </header>

    <section class="panel">
      <div class="panelHead">
        <div class="status" id="status">
          Stato: <b>in attesa…</b>
        </div>
        <div class="meta" id="meta"></div>
      </div>
      <div class="panelBody">
        <div id="grid" class="grid"></div>
        <div class="footerNote">
          *I dati arrivano da Google Sheets tramite Sheet.best. Se non vedi aggiornamenti, premi “Aggiorna” o ricarica la pagina.
        </div>
      </div>
    </section>

    <section id="adminPanel" class="panel hidden">
      <div class="panelHead">
        <div><b>Admin</b> <span class="meta">— aggiungi/modifica libri</span></div>
        <div class="row">
          <button id="btnLogout" class="danger">Logout</button>
        </div>
      </div>
      <div class="panelBody">
        <div class="twoCol">
          <div>
            <b>Aggiungi / Modifica libro</b>
            <div class="hint">Per modificare: clicca “Edit” su una card (serve login admin).</div>

            <form id="bookForm">
              <label>ID (unico)</label>
              <input id="id" required placeholder="es. ENG-AA-SL-2026-001" />
              <div class="hint">Usa un formato stabile e unico. L’ID è la chiave per edit/delete.</div>

              <label>Titolo</label>
              <input id="title" required />

              <label>Autore</label>
              <input id="author" />

              <label>Programma</label>
              <input id="programme" placeholder="IBDP / MYP / ..." />

              <label>Materia</label>
              <input id="subject" placeholder="English A / Math AA / ..." />

              <label>Anno</label>
              <input id="year" placeholder="2024 / 2025 / ..." />

              <label>Condizione</label>
              <input id="condition" placeholder="Like new / Good / ..." />

              <div class="twoCol">
                <div>
                  <label>Prezzo nuovo (€)</label>
                  <input id="newPrice" inputmode="decimal" placeholder="es. 45" />
                </div>
                <div>
                  <label>Prezzo BookLoop (€)</label>
                  <input id="loopPrice" inputmode="decimal" placeholder="es. 20" />
                </div>
              </div>

              <label>Disponibilità</label>
              <select id="availability" class="pill" style="width:100%">
                <option>Available</option>
                <option>Reserved</option>
                <option>Sold</option>
              </select>

              <label>Immagine (URL)</label>
              <input id="img" placeholder="https://..." />
              <div class="hint">Inserisci un URL diretto immagine (meglio .jpg/.png). Evita base64.</div>

              <div class="row" style="margin-top:12px">
                <button type="submit" class="primary" id="btnSave">Save</button>
                <button type="button" id="btnClear">Clear</button>
                <button type="button" id="btnDelete" class="danger hidden">Delete selected</button>
              </div>

              <div id="toast" class="toast hidden"></div>
            </form>
          </div>

          <div>
            <b>Note operative</b>
            <div class="hr"></div>
            <ul class="muted" style="line-height:1.6;margin:0;padding-left:18px">
              <li>Il catalogo è condiviso: ogni modifica scrive su Google Sheets.</li>
              <li>Per protezione reale serve un backend: qui è una soluzione semplice per un gruppo piccolo.</li>
              <li>Per prenotazioni: gli utenti aprono il link di Google Calendar e poi confermano la prenotazione sul sito (setta “Reserved”).</li>
            </ul>
            <div class="hr"></div>
            <div class="muted">
              <b>Consiglio</b>: crea un ID standard (es. <code>SUBJECT-YEAR-XXX</code>) così edit/delete funzionano sempre.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Reserve Modal -->
  <div id="reserveModal" class="modalOverlay hidden" role="dialog" aria-modal="true" aria-labelledby="reserveTitle">
    <div class="modalCard">
      <div class="modalHead">
        <div>
          <div id="reserveTitle" style="font-weight:800">Reserve</div>
          <div class="muted" id="reserveSubtitle" style="font-size:13px;margin-top:2px"></div>
        </div>
        <button type="button" id="reserveClose" class="tiny">✕</button>
      </div>

      <div class="modalBody">
        <label>Nome (obbligatorio)</label>
        <input id="reserveName" placeholder="es. Leonardo M." />

        <div class="hint">
          1) Apri Google Calendar e scegli uno slot.<br/>
          2) Torna qui e premi <b>Conferma prenotazione</b> (il libro diventa “Reserved” nel catalogo).
        </div>

        <div class="row" style="margin-top:12px">
          <a id="reserveCalendarLink" class="btnLink tiny primary" target="_blank" rel="noopener">Apri Google Calendar</a>
          <button type="button" id="reserveConfirm" class="tiny ok">Conferma prenotazione</button>
          <button type="button" id="reserveCancel" class="tiny danger">Annulla</button>
        </div>

        <div id="reserveMsg" class="toast hidden" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

<script>
  /*************************************************************
   * CONFIG
   *************************************************************/
  const SHEETBEST_BASE = "https://api.sheetbest.com/sheets/21769496-e3dd-4ffc-a766-643d0fd79d9c";
  const TAB_NAME = "Foglio1";
  const API = `${SHEETBEST_BASE}/tabs/${encodeURIComponent(TAB_NAME)}`;

  // Cambiala.
  const ADMIN_PASSWORD = "mazz";

  // Link del tuo Google Calendar "appointment schedule" / booking.
  // Se ne hai uno diverso, sostituiscilo qui.
  const CAL_BOOKING_URL = "https://calendar.app.google/AphKbShRvHjqcTev5";

  /*************************************************************
   * STATE
   *************************************************************/
  let books = [];
  let admin = false;
  let editingId = null;

  // reservation modal state
  let reservingId = null;

  /*************************************************************
   * DOM
   *************************************************************/
  const elGrid = document.getElementById("grid");
  const elStatus = document.getElementById("status");
  const elMeta = document.getElementById("meta");

  const elQ = document.getElementById("q");
  const elFProgram = document.getElementById("fProgram");
  const elFAvail = document.getElementById("fAvail");

  const btnRefresh = document.getElementById("btnRefresh");
  const btnAdmin = document.getElementById("btnAdmin");

  const adminPanel = document.getElementById("adminPanel");
  const btnLogout = document.getElementById("btnLogout");

  // form
  const form = document.getElementById("bookForm");
  const f = {
    id: document.getElementById("id"),
    title: document.getElementById("title"),
    author: document.getElementById("author"),
    programme: document.getElementById("programme"),
    subject: document.getElementById("subject"),
    year: document.getElementById("year"),
    condition: document.getElementById("condition"),
    newPrice: document.getElementById("newPrice"),
    loopPrice: document.getElementById("loopPrice"),
    availability: document.getElementById("availability"),
    img: document.getElementById("img"),
  };
  const btnSave = document.getElementById("btnSave");
  const btnClear = document.getElementById("btnClear");
  const btnDelete = document.getElementById("btnDelete");
  const toast = document.getElementById("toast");

  // reserve modal
  const reserveModal = document.getElementById("reserveModal");
  const reserveTitle = document.getElementById("reserveTitle");
  const reserveSubtitle = document.getElementById("reserveSubtitle");
  const reserveName = document.getElementById("reserveName");
  const reserveCalendarLink = document.getElementById("reserveCalendarLink");
  const reserveConfirm = document.getElementById("reserveConfirm");
  const reserveCancel = document.getElementById("reserveCancel");
  const reserveClose = document.getElementById("reserveClose");
  const reserveMsg = document.getElementById("reserveMsg");

  /*************************************************************
   * HELPERS
   *************************************************************/
  function setStatus(text, strong = "") {
    elStatus.innerHTML = `Stato: <b>${strong || text}</b>${strong ? ` <span class="muted">${text}</span>` : ""}`;
  }
  function showToast(msg, type="ok") {
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    toast.classList.remove("hidden");
    setTimeout(()=> toast.classList.add("hidden"), 3200);
  }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function norm(s){ return String(s ?? "").trim(); }

  function badgeClass(av){
    const v = String(av||"").toLowerCase();
    if(v === "available") return "ok";
    if(v === "reserved") return "warn";
    if(v === "sold") return "danger";
    return "";
  }

  function parsePrice(x){
    const s = String(x ?? "").replace(",", ".").trim();
    if(!s) return "";
    const n = Number(s);
    return Number.isFinite(n) ? n : "";
  }

  function fmtEUR(n){
    if(n === "" || n == null || !Number.isFinite(Number(n))) return "";
    const v = Number(n);
    // niente decimali in UI (se vuoi decimali, cambia 0 in 2)
    return `€ ${v.toFixed(0).replace(".", ",")}`;
  }

  function nowISO(){ return new Date().toISOString(); }

  function bookFromForm(){
    return {
      id: norm(f.id.value),
      title: norm(f.title.value),
      author: norm(f.author.value),
      programme: norm(f.programme.value),
      subject: norm(f.subject.value),
      year: norm(f.year.value),
      condition: norm(f.condition.value),
      newPrice: parsePrice(f.newPrice.value),
      loopPrice: parsePrice(f.loopPrice.value),
      availability: norm(f.availability.value) || "Available",
      img: norm(f.img.value),
      updatedAt: nowISO(),
      // optional fields (if present in sheet)
      reservedBy: "", reservedAt: ""
    };
  }

  function fillForm(b){
    editingId = b?.id || null;

    f.id.value = b?.id || "";
    f.title.value = b?.title || "";
    f.author.value = b?.author || "";
    f.programme.value = b?.programme || "";
    f.subject.value = b?.subject || "";
    f.year.value = b?.year || "";
    f.condition.value = b?.condition || "";

    f.newPrice.value = (b?.newPrice ?? "") !== "" && Number.isFinite(Number(b.newPrice))
      ? String(b.newPrice).replace(".", ",")
      : "";
    f.loopPrice.value = (b?.loopPrice ?? "") !== "" && Number.isFinite(Number(b.loopPrice))
      ? String(b.loopPrice).replace(".", ",")
      : "";

    f.availability.value = b?.availability || "Available";
    f.img.value = b?.img || "";

    // id non modificabile durante edit
    f.id.disabled = !!editingId;
    btnDelete.classList.toggle("hidden", !editingId);
  }

  function clearForm(){
    editingId = null;
    f.id.disabled = false;
    form.reset();
    f.availability.value = "Available";
    btnDelete.classList.add("hidden");
  }

  // Reserve modal helpers
  function showReserveMsg(msg, type="ok"){
    reserveMsg.className = `toast ${type}`;
    reserveMsg.textContent = msg;
    reserveMsg.classList.remove("hidden");
  }
  function openReserveModal(book){
    reservingId = book.id;
    reserveTitle.textContent = `Prenota: ${book.title || book.id}`;
    reserveSubtitle.textContent = `${book.author || ""}${book.subject ? " · " + book.subject : ""}`.trim();
    reserveName.value = "";
    reserveCalendarLink.href = CAL_BOOKING_URL;
    reserveMsg.className = "toast hidden";
    reserveMsg.textContent = "";
    reserveModal.classList.remove("hidden");
    setTimeout(()=> reserveName.focus(), 50);
  }
  function closeReserveModal(){
    reservingId = null;
    reserveModal.classList.add("hidden");
  }

  /*************************************************************
   * API CALLS (Sheet.best)
   *************************************************************/
  async function apiGetAll(){
    const r = await fetch(API, { method:"GET", mode:"cors" });
    if(!r.ok) throw new Error(`GET failed: ${r.status}`);
    const data = await r.json();
    if(!Array.isArray(data)) return [];
    return data.map(x => ({
      ...x,
      newPrice: x.newPrice === "" || x.newPrice == null ? "" : Number(String(x.newPrice).replace(",", ".")),
      loopPrice: x.loopPrice === "" || x.loopPrice == null ? "" : Number(String(x.loopPrice).replace(",", ".")),
    }));
  }

  // Upsert: PATCH per id, se non aggiorna nulla => POST
  async function apiUpsert(book){
    const id = encodeURIComponent(book.id);
    const patchUrl = `${API}/id/${id}`;

    const r1 = await fetch(patchUrl, {
      method:"PATCH",
      mode:"cors",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(book)
    });

    if(!r1.ok){
      const t = await r1.text().catch(()=> "");
      throw new Error(`PATCH failed (${r1.status}). ${t}`);
    }

    const d1 = await r1.json().catch(()=>[]);
    if(Array.isArray(d1) && d1.length > 0){
      return { mode:"patch", updated:true };
    }

    const r2 = await fetch(API, {
      method:"POST",
      mode:"cors",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(book)
    });

    if(!r2.ok){
      const t = await r2.text().catch(()=> "");
      throw new Error(`POST failed (${r2.status}). ${t}`);
    }

    await r2.json().catch(()=>null);
    return { mode:"post", inserted:true };
  }

  async function apiDeleteById(idVal){
    const url = `${API}/id/${encodeURIComponent(idVal)}`;
    const r = await fetch(url, { method:"DELETE", mode:"cors" });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(`DELETE failed (${r.status}). ${t}`);
    }
    await r.json().catch(()=>null);
    return true;
  }

  /*************************************************************
   * RENDER
   *************************************************************/
  function applyFilters(list){
    const q = norm(elQ.value).toLowerCase();
    const p = norm(elFProgram.value).toLowerCase();
    const a = norm(elFAvail.value).toLowerCase();

    return list.filter(b=>{
      const hay = `${b.title||""} ${b.author||""} ${b.subject||""} ${b.programme||""} ${b.id||""}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(p && String(b.programme||"").toLowerCase() !== p) return false;
      if(a && String(b.availability||"").toLowerCase() !== a) return false;
      return true;
    });
  }

  function render(){
    const list = applyFilters(books);
    elMeta.textContent = `${list.length} / ${books.length} libri`;

    elGrid.innerHTML = list.map(b=>{
      const av = b.availability || "Available";
      const bc = badgeClass(av);
      const img = norm(b.img);
      const hasImg = !!img;

      const np = fmtEUR(b.newPrice);
      const lp = fmtEUR(b.loopPrice);

      const reservedBy = norm(b.reservedBy);
      const reservedAt = norm(b.reservedAt);

      const reserveDisabled = String(av).toLowerCase() !== "available";

      return `
        <div class="cardRow">
          <div class="infoCol">
            <div class="badge ${bc}">${esc(av)}</div>

            <div>
              <div class="title">${esc(b.title || "(Senza titolo)")}</div>
              <div class="muted">${esc(b.author || "")}</div>
            </div>

            <div class="kv">
              <div>Programma</div><div><b>${esc(b.programme||"-")}</b></div>
              <div>Materia</div><div><b>${esc(b.subject||"-")}</b></div>
              <div>Anno</div><div><b>${esc(b.year||"-")}</b></div>
              <div>Prezzi</div><div><b>${esc(lp || "-")}</b> <span class="muted">(nuovo: ${esc(np || "-")})</span></div>
            </div>

            ${
              String(av).toLowerCase() === "reserved" && (reservedBy || reservedAt)
              ? `<div class="muted" style="font-size:12px">
                   <b>Reserved</b>${reservedBy ? ` · by ${esc(reservedBy)}` : ``}${reservedAt ? ` · ${esc(reservedAt).slice(0,10)}` : ``}
                 </div>`
              : ``
            }

            <div class="cardActions">
              ${
                !admin
                  ? (reserveDisabled
                      ? `<button class="tiny" disabled>Not available</button>`
                      : `<button class="tiny primary" data-reserve="${esc(b.id)}">Reserve</button>`
                    )
                  : ``
              }

              ${admin ? `<button class="tiny ok" data-edit="${esc(b.id)}">Edit</button>` : ``}
              ${admin ? `<button class="tiny danger" data-del="${esc(b.id)}">Delete</button>` : ``}
              <button class="tiny" data-copy="${esc(b.id)}">Copy ID</button>
            </div>

            <div class="muted" style="margin-top:4px;font-size:12px">
              ID: <b>${esc(b.id||"-")}</b>
            </div>
          </div>

          <div class="imgCol">
            ${hasImg ? `<img src="${esc(img)}" alt="${esc(b.title||"")}" />` : `<div class="muted">No image</div>`}
          </div>
        </div>
      `;
    }).join("");

    // bind actions
    elGrid.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-copy");
        navigator.clipboard?.writeText(id).catch(()=>{});
        showToast(`ID copiato: ${id}`, "ok");
      });
    });

    // reserve buttons
    elGrid.querySelectorAll("[data-reserve]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-reserve");
        const b = books.find(x => String(x.id) === String(id));
        if(!b) return;
        openReserveModal(b);
      });
    });

    // admin buttons
    if(admin){
      elGrid.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-edit");
          const b = books.find(x => String(x.id) === String(id));
          if(!b) return;
          adminPanel.scrollIntoView({behavior:"smooth", block:"start"});
          fillForm(b);
          showToast("Modalità modifica attiva", "ok");
        });
      });

      elGrid.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-del");
          if(!confirm(`Eliminare il libro con ID "${id}"?`)) return;
          try{
            setStatus("Eliminazione…", "working");
            await apiDeleteById(id);
            await refresh();
            showToast("Libro eliminato", "ok");
          }catch(e){
            console.error(e);
            showToast(`Errore delete: ${e.message}`, "danger");
            setStatus("Errore", "error");
          }
        });
      });
    }
  }

  /*************************************************************
   * FLOW
   *************************************************************/
  async function refresh(){
    setStatus("Caricamento dal Google Sheet…", "loading");
    try{
      const data = await apiGetAll();

      // sort: Available -> Reserved -> Sold, poi titolo
      const rank = (x)=>{
        const v = String(x.availability||"").toLowerCase();
        if(v==="available") return 0;
        if(v==="reserved") return 1;
        if(v==="sold") return 2;
        return 3;
      };

      books = data.sort((a,b)=>{
        const d = rank(a) - rank(b);
        if(d!==0) return d;
        return String(a.title||"").localeCompare(String(b.title||""), "it");
      });

      setStatus("OK", "ready");
      render();
    }catch(e){
      console.error(e);
      setStatus("Errore nel caricamento (controlla API/permessi).", "error");
      showToast(`Errore GET: ${e.message}`, "danger");
    }
  }

  /*************************************************************
   * EVENTS
   *************************************************************/
  btnRefresh.addEventListener("click", refresh);
  elQ.addEventListener("input", render);
  elFProgram.addEventListener("change", render);
  elFAvail.addEventListener("change", render);

  btnAdmin.addEventListener("click", ()=>{
    if(admin){
      adminPanel.classList.toggle("hidden");
      render();
      return;
    }
    const pwd = prompt("Password admin:");
    if(pwd == null) return;
    if(pwd !== ADMIN_PASSWORD){
      alert("Password errata.");
      return;
    }
    admin = true;
    adminPanel.classList.remove("hidden");
    render();
    showToast("Admin attivo", "ok");
  });

  btnLogout.addEventListener("click", ()=>{
    admin = false;
    adminPanel.classList.add("hidden");
    clearForm();
    render();
    showToast("Logout", "ok");
  });

  btnClear.addEventListener("click", clearForm);

  btnDelete.addEventListener("click", async ()=>{
    if(!editingId) return;
    if(!confirm(`Eliminare il libro con ID "${editingId}"?`)) return;
    try{
      setStatus("Eliminazione…", "working");
      await apiDeleteById(editingId);
      clearForm();
      await refresh();
      showToast("Libro eliminato", "ok");
    }catch(e){
      console.error(e);
      showToast(`Errore delete: ${e.message}`, "danger");
      setStatus("Errore", "error");
    }
  });

  form.addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    if(!admin){ alert("Devi fare login admin."); return; }

    const book = bookFromForm();
    if(!book.id || !book.title){
      showToast("ID e Titolo sono obbligatori.", "danger");
      return;
    }

    btnSave.disabled = true;
    setStatus("Salvataggio su Google Sheet…", "saving");

    try{
      const res = await apiUpsert(book);
      await refresh();
      showToast(res.mode === "post" ? "Libro aggiunto." : "Libro aggiornato.", "ok");
      clearForm();
      setStatus("OK", "ready");
    }catch(e){
      console.error(e);
      showToast(
        `Errore salvataggio: ${e.message}\n` +
        `Controlla: (1) Sheet condiviso come Editor, (2) TAB "${TAB_NAME}", (3) colonne ok.`,
        "danger"
      );
      setStatus("Errore", "error");
    } finally {
      btnSave.disabled = false;
    }
  });

  // Reserve modal events
  reserveCancel.addEventListener("click", closeReserveModal);
  reserveClose.addEventListener("click", closeReserveModal);
  reserveModal.addEventListener("click", (e)=>{
    if(e.target === reserveModal) closeReserveModal();
  });

  reserveConfirm.addEventListener("click", async ()=>{
    if(!reservingId) return;

    const name = norm(reserveName.value);
    if(!name){
      showReserveMsg("Inserisci il nome.", "danger");
      return;
    }

    const b = books.find(x => String(x.id) === String(reservingId));
    if(!b){
      showReserveMsg("Libro non trovato. Premi Aggiorna e riprova.", "danger");
      return;
    }

    if(String(b.availability||"").toLowerCase() !== "available"){
      showReserveMsg("Questo libro non è più disponibile. Premi Aggiorna.", "danger");
      return;
    }

    try{
      setStatus("Salvataggio prenotazione…", "saving");

      const t = nowISO();
      const updated = {
        ...b,
        availability: "Reserved",
        reservedBy: name,
        reservedAt: t,
        updatedAt: t
      };

      await apiUpsert(updated);
      await refresh();

      showToast("Prenotazione salvata ✅", "ok");
      closeReserveModal();
      setStatus("OK", "ready");
    }catch(e){
      console.error(e);
      showReserveMsg(`Errore: ${e.message}`, "danger");
      setStatus("Errore", "error");
    }
  });

  /*************************************************************
   * START
   *************************************************************/
  refresh();
</script>
</body>
</html>
